generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// Enums
enum Role {
  ADMIN
  MANAGER
  CASHIER
}

enum ProductType {
  TIRE
  BALE
}

enum TireCategory {
  NEW
  SECOND_HAND
}

enum TireUsage {
  FOUR_BY_FOUR
  REGULAR
  TRUCK
}

enum ProductGrade {
  A
  B
  C
}

// Models
model User {
  id            String    @id @default(cuid())
  firstName     String    @map("first_name")
  lastName      String    @map("last_name")
  email         String    @unique
  passwordHash  String    @map("password_hash")
  phoneNumber   String?   @default("") @map("phone_number")
  role          Role      @default(CASHIER)
  isActive      Boolean   @default(true) @map("is_active")
  emailVerified DateTime? @map("email_verified")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  // Relationships
  employee          Employee?
  refreshTokens     RefreshToken[]
  verificationCodes VerificationCode[]
  passwordResets    PasswordReset[]
  activityLogs      ActivityLog[]

  @@map("users")
}

model RefreshToken {
  id           String        @id @default(cuid())
  user         User          @relation(fields: [userId], references: [id])
  userId       String
  tokenHash    String        @map("token_hash")
  revoked      Boolean       @default(false)
  createdAt    DateTime      @default(now()) @map("created_at")
  expiresAt    DateTime      @map("expires_at")
  replacedById String?       @map("replaced_by_id")
  replacedBy   RefreshToken? @relation("Replacement", fields: [replacedById], references: [id])

  RefreshToken RefreshToken[] @relation("Replacement")

  @@map("refresh_tokens")
}

model VerificationCode {
  id        String   @id @default(cuid())
  user      User     @relation(fields: [userId], references: [id])
  userId    String
  code      String
  createdAt DateTime @default(now()) @map("created_at")
  expiresAt DateTime @map("expires_at")
  used      Boolean  @default(false)

  @@map("verification_codes")
}

model PasswordReset {
  id        String   @id @default(cuid())
  user      User     @relation(fields: [userId], references: [id])
  userId    String
  tokenHash String   @map("token_hash")
  expiresAt DateTime @map("expires_at")
  used      Boolean  @default(false)
  createdAt DateTime @default(now()) @map("created_at")

  @@map("password_resets")
}

model Employee {
  id        String @id @default(cuid())
  firstName String @map("first_name")
  lastName  String @map("last_name")
  phone     String
  position  String @default("Clerk")

  // Relationships
  store   Store  @relation(fields: [storeId], references: [id])
  storeId String @map("store_id")
  user    User   @relation(fields: [userId], references: [id])
  userId  String @unique

  sales     Sale[]
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([storeId])
  @@index([userId])
  @@map("employees")
}

model Store {
  id       String @id @default(cuid())
  name     String @map("branch_name")
  location String @map("branch_location")

  // Relationships
  employees            Employee[]
  products             Product[]
  sales                Sale[]
  storeProducts        StoreProduct[]
  productTransfersFrom ProductTransfer[] @relation("FromStore")
  productTransfersTo   ProductTransfer[] @relation("ToStore")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("branches")
}

model Product {
  id        String       @id @default(cuid())
  name      String       @map("product_name")
  price     Float        @map("product_price")
  quantity  Int          @map("product_quantity")
  type      ProductType
  grade     ProductGrade
  commodity String?

  // Store relationship
  store   Store  @relation(fields: [storeId], references: [id])
  storeId String @map("store_id")

  // Tire-specific fields
  tireCategory   TireCategory? @map("tire_category")
  tireUsage      TireUsage?    @map("tire_usage")
  tireSize       String?       @map("tire_size")
  loadIndex      String?       @map("load_index")
  speedRating    String?       @map("speed_rating")
  warrantyPeriod String?       @map("warranty_period")

  // Bale-specific fields
  baleWeight    Float?    @map("bale_weight")
  baleCategory  String?   @map("bale_category")
  originCountry String?   @map("origin_country")
  importDate    DateTime? @map("import_date")
  baleCount     Int?      @map("bale_count")

  // Relationships
  saleItems        SaleItem[]
  storeProducts    StoreProduct[]
  productTransfers ProductTransfer[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([id, storeId])
  @@map("products")
}

// Many-to-many junction table for products available in multiple stores
model StoreProduct {
  id String @id @default(cuid())

  // Relationships
  productId String  @map("product_id")
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  storeId String @map("store_id")
  store   Store  @relation(fields: [storeId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now()) @map("created_at")

  @@unique([productId, storeId])
  @@map("store_products")
}

model Sale {
  id String @id @default(cuid())

  // Relationships
  employee   Employee @relation(fields: [employeeId], references: [id])
  employeeId String   @map("employee_id")

  store   Store  @relation(fields: [storeId], references: [id])
  storeId String @map("store_id")

  saleItems SaleItem[]
  total     Float

  createdAt DateTime @default(now()) @map("created_at")

  // Voided sale relationship
  voidedSale VoidedSale?

  @@index([storeId])
  @@index([employeeId])
  @@index([createdAt])
  @@map("sales")
}

model SaleItem {
  id String @id @default(cuid())

  // Relationships
  sale   Sale   @relation(fields: [saleId], references: [id])
  saleId String @map("sale_id")

  product   Product @relation(fields: [productId], references: [id])
  productId String  @map("product_id")

  quantity Int
  price    Float

  @@map("sale_items")
}

model ActivityLog {
  id         String   @id @default(cuid())
  user       User     @relation(fields: [userId], references: [id])
  userId     String
  action     String
  entityType String
  entityId   String
  details    Json
  createdAt  DateTime @default(now()) @map("created_at")

  @@index([userId])
  @@index([action])
  @@index([entityType, entityId])
  @@index([createdAt])
  @@map("activity_logs")
}

model ProductTransfer {
  id            String   @id @default(cuid())
  product       Product  @relation(fields: [productId], references: [id])
  productId     String
  fromStore     Store    @relation("FromStore", fields: [fromStoreId], references: [id])
  fromStoreId   String
  toStore       Store    @relation("ToStore", fields: [toStoreId], references: [id])
  toStoreId     String
  quantity      Int
  transferredBy String
  status        String   @default("PENDING") // PENDING, COMPLETED, CANCELLED
  notes         String?
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  @@map("product_transfers")
}

model VoidedSale {
  id            String   @id @default(cuid())
  saleId        String   @unique
  sale          Sale     @relation(fields: [saleId], references: [id])
  voidedBy      String
  reason        String?
  originalTotal Float
  createdAt     DateTime @default(now()) @map("created_at")

  @@map("voided_sales")
}
