generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ========== User & Authentication ==========
model User {
  id         String    @id @default(cuid())
  firstName  String
  lastName   String
  email      String
  password   String
  phone      String
  role       Role
  isActive   Boolean   @default(true)
  isVerified Boolean   @default(false)
  lastLogin  DateTime?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  // Relationships
  employee           Employee?
  store              Store?             @relation(fields: [storeId], references: [id])
  storeId            String?
  refreshTokens      RefreshToken[]
  verificationCodes  VerificationCode[]
  passwordResets     PasswordReset[]
  activities         ActivityLog[]
  sales              Sale[]
  productTransfers   ProductTransfer[]
  inventoryHistories InventoryHistory[]

  @@unique([email])
  @@index([role])
  @@index([storeId])
}

model RefreshToken {
  id           String   @id @default(cuid())
  userId       String
  tokenHash    String
  revoked      Boolean  @default(false)
  createdAt    DateTime @default(now())
  expiresAt    DateTime
  replacedById String?

  // Relationships
  user              User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  replacedBy        RefreshToken?  @relation("RefreshTokenReplacement", fields: [replacedById], references: [id])
  replacementTokens RefreshToken[] @relation("RefreshTokenReplacement")

  @@index([userId])
  @@index([tokenHash])
  @@index([expiresAt])
}

model VerificationCode {
  id        String   @id @default(cuid())
  userId    String
  code      String
  createdAt DateTime @default(now())
  expiresAt DateTime
  used      Boolean  @default(false)

  // Relationships
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([code])
  @@index([expiresAt])
}

model PasswordReset {
  id        String   @id @default(cuid())
  userId    String
  tokenHash String
  expiresAt DateTime
  used      Boolean  @default(false)
  createdAt DateTime @default(now())

  // Relationships
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([tokenHash])
  @@index([expiresAt])
}

// ========== Store ==========
model Store {
  id          String   @id @default(cuid())
  name        String
  location    String
  phone       String   @map("phone_number")
  email       String
  isMainStore Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relationships
  employees         Employee[]
  inventories       Inventory[]
  sales             Sale[]
  storeProducts     StoreProduct[]
  sentTransfers     ProductTransfer[] @relation("SentTransfers")
  receivedTransfers ProductTransfer[] @relation("ReceivedTransfers")
  users             User[]

  @@unique([email])
  @@index([name])
  @@index([isMainStore])
}

// ========== Product ==========
model Product {
  id        String       @id @default(cuid())
  name      String       @unique
  basePrice Float
  type      ProductType
  grade     ProductGrade
  commodity String?

  // Tire-specific fields
  tireCategory   TireCategory?
  tireUsage      TireUsage?
  tireSize       String?
  loadIndex      String?
  speedRating    String?
  warrantyPeriod String?

  // Bale-specific fields
  baleWeight    Float?
  baleCategory  String?
  originCountry String?
  importDate    DateTime?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relationships
  inventories   Inventory[]
  saleItems     SaleItem[]
  transfers     ProductTransfer[]
  storeProducts StoreProduct[]

  @@index([type])
  @@index([grade])
  @@index([name])
}

// ========== Inventory (Core) ==========
model Inventory {
  id           String @id @default(cuid())
  productId    String
  storeId      String
  quantity     Int    @default(0)
  reorderLevel Int?   @default(10)
  optimalLevel Int?   @default(50)
  storePrice   Float?

  // Relationships
  product           Product            @relation(fields: [productId], references: [id], onDelete: Cascade)
  store             Store              @relation(fields: [storeId], references: [id], onDelete: Cascade)
  sentTransfers     ProductTransfer[]  @relation("FromInventory")
  receivedTransfers ProductTransfer[]  @relation("ToInventory")
  histories         InventoryHistory[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([productId, storeId])
  @@index([storeId])
  @@index([productId])
  @@index([quantity])
}

// ========== Product Transfer (Optimized) ==========
model ProductTransfer {
  id       String @id @default(cuid())
  quantity Int

  // Required foreign keys for Prisma relationships
  fromInventoryId String
  toInventoryId   String
  productId       String // Required for direct queries
  fromStoreId     String // Required for store relationship
  toStoreId       String // Required for store relationship
  transferredBy   String // userId

  // Status
  status TransferStatus @default(PENDING)
  reason String?
  notes  String?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relationships (Prisma requires these for proper typing)
  fromInventory     Inventory @relation("FromInventory", fields: [fromInventoryId], references: [id])
  toInventory       Inventory @relation("ToInventory", fields: [toInventoryId], references: [id])
  product           Product   @relation(fields: [productId], references: [id])
  fromStore         Store     @relation("SentTransfers", fields: [fromStoreId], references: [id])
  toStore           Store     @relation("ReceivedTransfers", fields: [toStoreId], references: [id])
  transferredByUser User      @relation(fields: [transferredBy], references: [id], onDelete: Restrict)

  @@index([fromInventoryId])
  @@index([toInventoryId])
  @@index([productId])
  @@index([fromStoreId])
  @@index([toStoreId])
  @@index([status])
  @@index([createdAt])
}

// ========== Inventory History ==========
model InventoryHistory {
  id               String              @id @default(cuid())
  inventoryId      String
  changeType       InventoryChangeType
  quantityChange   Int
  previousQuantity Int
  newQuantity      Int
  referenceId      String?
  referenceType    String?
  notes            String?
  createdBy        String

  // Relationships
  inventory Inventory @relation(fields: [inventoryId], references: [id], onDelete: Cascade)
  user      User      @relation(fields: [createdBy], references: [id], onDelete: Restrict)

  createdAt DateTime @default(now())

  @@index([inventoryId])
  @@index([createdAt])
  @@index([referenceType, referenceId])
}

// ========== Store Product (Join Table) ==========
model StoreProduct {
  id        String   @id @default(cuid())
  productId String
  storeId   String
  createdAt DateTime @default(now())

  // Relationships
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  store   Store   @relation(fields: [storeId], references: [id], onDelete: Cascade)

  @@unique([productId, storeId])
  @@index([storeId])
}

// ========== Sales ==========
model Sale {
  id            String            @id @default(cuid())
  employeeId    String
  storeId       String
  userId        String?
  total         Float
  subtotal      Float
  tax           Float
  createdAt     DateTime          @default(now())
  paymentMethod PaymentMethodType

  customerName  String?
  customerEmail String?
  customerPhone String?

  // Relationships
  employee   Employee    @relation(fields: [employeeId], references: [id], onDelete: Restrict)
  store      Store       @relation(fields: [storeId], references: [id], onDelete: Restrict)
  user       User?       @relation(fields: [userId], references: [id])
  saleItems  SaleItem[]
  voidedSale VoidedSale?

  @@index([employeeId])
  @@index([storeId])
  @@index([createdAt])
  @@index([paymentMethod])
}

model SaleItem {
  id        String @id @default(cuid())
  saleId    String
  productId String
  quantity  Int
  price     Float

  // Relationships
  sale    Sale    @relation(fields: [saleId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id], onDelete: Restrict)

  @@unique([saleId, productId])
  @@index([saleId])
  @@index([productId])
}

model VoidedSale {
  id            String   @id @default(cuid())
  saleId        String   @unique
  voidedBy      String
  reason        String?
  originalTotal Float
  createdAt     DateTime @default(now())

  // Relationships
  sale Sale @relation(fields: [saleId], references: [id], onDelete: Cascade)

  @@index([saleId])
  @@index([createdAt])
}

// ========== Employees ==========
model Employee {
  id       String @id @default(cuid())
  userId   String @unique
  storeId  String
  position String
  role     Role

  // Relationships
  user  User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  store Store  @relation(fields: [storeId], references: [id], onDelete: Cascade)
  sales Sale[]

  @@index([storeId])
  @@index([role])
  @@index([position])
}

// ========== Activity Logs ==========
model ActivityLog {
  id         String   @id @default(cuid())
  userId     String
  action     String
  entityType String
  entityId   String
  details    Json
  createdAt  DateTime @default(now())

  // Relationships
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([entityType, entityId])
  @@index([createdAt])
}

// ========== Enums ==========
enum Role {
  ADMIN
  MANAGER
  CASHIER
}

enum ProductType {
  TIRE
  BALE
}

enum TireCategory {
  NEW
  SECOND_HAND
}

enum TireUsage {
  FOUR_BY_FOUR
  REGULAR
  TRUCK
}

enum ProductGrade {
  A
  B
  C
}

enum PaymentMethodType {
  MOBILE
  CASH
  CARD
}

enum TransferStatus {
  PENDING
  COMPLETED
  CANCELLED
  REJECTED
}

enum InventoryChangeType {
  PURCHASE
  SALE
  TRANSFER_OUT
  TRANSFER_IN
  ADJUSTMENT
  RETURN
  DAMAGE
}

enum SortOrder {
  asc
  desc
}
